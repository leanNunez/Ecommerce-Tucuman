<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - E-commerce</title>
    <link rel="stylesheet" href="../css/admin-dashboard.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üõí E-commerce</h2>
                <div class="sidebar-user">
                    <span id="user-name">Cargando...</span><br>
                    <small id="user-email"></small>
                </div>
            </div>

            <ul class="sidebar-nav">
                <li><a href="index.html" class="active">üìä Dashboard</a></li>
                <li><a href="productos.html">üì¶ Productos</a></li>
                <li><a href="pedidos.html">üõí Pedidos</a></li>
                <li><a href="clientes.html">üë• Clientes</a></li>
                <li><a href="categorias.html">üìÇ Categor√≠as</a></li>
                <li><a href="perfil.html">üë§ Mi Perfil</a></li>
                <li><a href="../index.html">üè™ Ver Tienda</a></li>
            </ul>

            <div class="sidebar-footer">
                <button class="btn-logout" onclick="cerrarSesion()">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1>Dashboard</h1>
                <div class="breadcrumb">Panel de Administraci√≥n / Dashboard</div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Productos</h3>
                    <div class="stat-value" id="stat-productos">0</div>
                </div>
                <div class="stat-card">
                    <h3>Stock Total</h3>
                    <div class="stat-value" id="stat-stock">0</div>
                </div>
                <div class="stat-card">
                    <h3>Destacados</h3>
                    <div class="stat-value" id="stat-destacados">0</div>
                </div>
                <div class="stat-card">
                    <h3>Categor√≠as</h3>
                    <div class="stat-value" id="stat-categorias">0</div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2>Productos Recientes</h2>
                    <button class="btn-primary" onclick="alert('Funcionalidad pr√≥ximamente')">
                        + Nuevo Producto
                    </button>
                </div>

                <div id="loading" class="loading">
                    <p>‚è≥ Cargando productos...</p>
                </div>

                <div id="productos-tabla" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Categor√≠a</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productos-tbody">
                            <!-- Se llena con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // Verificar autenticaci√≥n
        window.addEventListener('DOMContentLoaded', () => {
            verificarAutenticacion();
            cargarDatosUsuario();
            cargarEstadisticas();
            cargarProductos();
        });

        function verificarAutenticacion() {
            const token = localStorage.getItem('token');
            const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');

            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Verificar si es admin
            if (usuario.tipo !== 'admin') {
                alert('Acceso denegado. Solo administradores.');
                localStorage.clear();
                window.location.href = '../index.html';
            }
        }

        function cargarDatosUsuario() {
            const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
            document.getElementById('user-name').textContent = usuario.nombre || 'Usuario';
            document.getElementById('user-email').textContent = usuario.email || '';
        }

        async function cargarEstadisticas() {
            try {
                const response = await API.get('/productos', { limit: 1000 });
                
                if (response.success) {
                    const productos = response.data;
                    
                    document.getElementById('stat-productos').textContent = productos.length;
                    
                    const stockTotal = productos.reduce((sum, p) => sum + parseInt(p.stock || 0), 0);
                    document.getElementById('stat-stock').textContent = stockTotal;
                    
                    const destacados = productos.filter(p => p.destacado).length;
                    document.getElementById('stat-destacados').textContent = destacados;
                }

                // Cargar categor√≠as
                const catResponse = await API.get('/categorias');
                if (catResponse.success) {
                    document.getElementById('stat-categorias').textContent = catResponse.data.length;
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
            }
        }

        async function cargarProductos() {
            const loading = document.getElementById('loading');
            const tabla = document.getElementById('productos-tabla');
            const tbody = document.getElementById('productos-tbody');

            try {
                const response = await API.get('/productos', { limit: 10, orden: 'recientes' });

                loading.style.display = 'none';
                tabla.style.display = 'block';

                if (response.success && response.data.length > 0) {
                    tbody.innerHTML = response.data.map(producto => `
                        <tr>
                            <td>
                                <img src="${producto.imagen_principal || '../img/placeholder.jpg'}" 
                                     alt="${producto.nombre}"
                                     class="product-img"
                                     onerror="this.src='../img/placeholder.jpg'">
                            </td>
                            <td><strong>${producto.nombre}</strong></td>
                            <td>${producto.categoria_nombre || 'Sin categor√≠a'}</td>
                            <td><strong>$${parseFloat(producto.precio).toLocaleString('es-AR')}</strong></td>
                            <td>${producto.stock}</td>
                            <td>
                                <span class="badge ${producto.activo ? 'badge-success' : 'badge-danger'}">
                                    ${producto.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-sm btn-edit" onclick="editarProducto(${producto.id})">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button class="btn-sm btn-delete" onclick="eliminarProducto(${producto.id})">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No hay productos</td></tr>';
                }
            } catch (error) {
                console.error('Error al cargar productos:', error);
                loading.style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #ef4444;">Error al cargar productos</td></tr>';
            }
        }

        function editarProducto(id) {
            alert(`Editar producto ${id} - Funcionalidad pr√≥ximamente`);
        }

        async function eliminarProducto(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;

            try {
                const response = await API.delete(`/productos/${id}`);
                
                if (response.success) {
                    alert('Producto eliminado exitosamente');
                    cargarProductos();
                    cargarEstadisticas();
                } else {
                    alert('Error al eliminar: ' + response.error);
                }
            } catch (error) {
                alert('Error al eliminar producto');
                console.error(error);
            }
        }

        function cerrarSesion() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('usuario');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>